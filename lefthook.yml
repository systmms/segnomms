# Lefthook configuration for segnomms
# See https://github.com/evilmartians/lefthook for more information

commit-msg:
  commands:
    conventional-commits:
      run: ./repo/validate_conventional_commits.sh --commit-msg="{1}" --local-mode

pre-commit:
  parallel: true
  commands:
    # GitHub Actions linting
    actionlint:
      glob: ".github/workflows/*.{yml,yaml}"
      run: actionlint {staged_files}
    # Python code formatting - Black
    black:
      glob: "*.py"
      run: black {staged_files}
      stage_fixed: true
    # Python import sorting - isort
    isort:
      glob: "*.py"
      run: isort --profile black {staged_files}
      stage_fixed: true
    # Python linting - Flake8
    flake8:
      glob: "*.py"
      exclude: "examples/**/*.py"
      # Temporary ignores - working to systematically remove these rules:
      # F841: Unused variables (Priority 1) - STRATEGIC (enhanced with validation assertions)
      # REMOVED: E402 (import placement) - HANDLED âœ… (per-file-ignores in .flake8 for legitimate patterns)
      # REMOVED: F401 (unused imports) - FIXED âœ… (20â†’4 violations, 80% reduction, remaining are legitimate)
      # REMOVED: F821 (undefined names), F811 (redefinitions) - FIXED âœ…
      # REMOVED: E226 (operator spacing), E712 (boolean comparison), E501 (line length) - FIXED âœ…
      # REMOVED: F541 (f-string placeholders), E722 (bare except) - FIXED âœ…
      # ðŸŽ¯ ACHIEVEMENT: 90% rule reduction (10â†’1 rules) with hierarchical configuration
      run: flake8 --extend-ignore=F841 {staged_files}
    # General file checks - using pre-commit-hooks for autofix
    trailing-whitespace:
      run: python -m pre_commit_hooks.trailing_whitespace_fixer {staged_files}
      stage_fixed: true

    end-of-file:
      run: python -m pre_commit_hooks.end_of_file_fixer {staged_files}
      stage_fixed: true

    check-yaml:
      glob: "*.{yml,yaml}"
      exclude: ".github/workflows/*.{yml,yaml}"
      run: |
        for file in {staged_files}; do
          python -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
        done

    check-json:
      glob: "*.json"
      run: |
        for file in {staged_files}; do
          python -m json.tool "$file" > /dev/null || exit 1
        done

    check-merge-conflict:
      run: |
        for file in {staged_files}; do
          if grep -E '^[<>|=]{7}' "$file"; then
            echo "Merge conflict markers found in $file"
            exit 1
          fi
        done

    debug-statements:
      glob: "*.py"
      run: |
        for file in {staged_files}; do
          if grep -E '(import pdb|pdb\.set_trace\(\)|import ipdb|ipdb\.set_trace\(\))' "$file"; then
            echo "Debug statements found in $file"
            exit 1
          fi
        done

    # Type checking - MyPy with comprehensive configuration from pyproject.toml
    mypy:
      glob: "*.py"
      exclude: "tests/|examples/|repo/"
      run: mypy {staged_files}

    # Repository scripts should trigger when changed
    repo-scripts:
      glob: "repo/*.py"
      run: |
        echo "Repository script changed: {staged_files}"
        echo "Consider running relevant tests if scripts are modified"

    # Documentation dependency check (for docs changes)
    doc-dependencies:
      glob: "docs/**/*.{rst,md,py}"
      run: python repo/check_doc_dependencies.py

    # Documentation build test (optional - can be skipped with LEFTHOOK_EXCLUDE)
    doc-build:
      glob: "docs/**/*.{rst,md,py}"
      run: python repo/check_doc_build.py --skip-if-missing-deps --quiet

    # Documentation spell checking (optional - can be skipped with LEFTHOOK_EXCLUDE)
    spell-check:
      glob: "docs/**/*.rst"
      run: |
        # Install spell checker if needed
        if ! command -v aspell &> /dev/null; then
          echo "Installing spell checker..."
          ./repo/setup_spell_checker.sh
        fi
        # Run spell check on documentation files
        python repo/spell_check_docs.py --files {staged_files} --quiet

    # Project dictionary changes should trigger spell check
    spell-check-dict:
      glob: "repo/aspell_project_dict.txt"
      run: |
        echo "Project dictionary updated - running full spell check"
        if ! command -v aspell &> /dev/null; then
          echo "Installing spell checker..."
          ./repo/setup_spell_checker.sh
        fi
        python repo/spell_check_docs.py --quiet
