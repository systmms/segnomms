name: Coverage Tracking

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'segnomms/**/*.py'
      - 'tests/**/*.py'
      - 'pyproject.toml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'segnomms/**/*.py'
      - 'tests/**/*.py'
      - 'pyproject.toml'

env:
  PYTHON_VERSION: "3.11"

jobs:
  coverage-analysis:
    name: Coverage Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v6

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true
        cache-dependency-glob: "**/uv.lock"

    - name: Set up Python
      run: uv python install ${{ env.PYTHON_VERSION }}

    - name: Cache UV and Virtual Environment
      uses: actions/cache@v5
      with:
        path: |
          ~/.cache/uv
          .venv
        key: uv-${{ runner.os }}-python${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock', 'pyproject.toml') }}
        restore-keys: |
          uv-${{ runner.os }}-python${{ env.PYTHON_VERSION }}-
          uv-${{ runner.os }}-

    - name: Install dependencies
      run: |
        uv sync
        uv pip install -e .

    - name: Run comprehensive test coverage
      run: repo/run_comprehensive_coverage.sh

    - name: Generate coverage badge
      run: repo/generate_coverage_badge.sh

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Upload HTML coverage report
      uses: actions/upload-artifact@v6
      with:
        name: coverage-report-html
        path: htmlcov/

    - name: Generate coverage summary
      run: repo/generate_coverage_summary.sh

    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v8
      with:
        script: |
          const fs = require('fs');
          try {
            const summary = fs.readFileSync('coverage-summary.md', 'utf8');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
          } catch (error) {
            console.log('Could not post coverage comment:', error);
          }

  coverage-diff:
    name: Coverage Diff
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true
        cache-dependency-glob: "**/uv.lock"

    - name: Set up Python
      run: uv python install ${{ env.PYTHON_VERSION }}

    - name: Cache UV and Virtual Environment
      uses: actions/cache@v5
      with:
        path: |
          ~/.cache/uv
          .venv
        key: uv-${{ runner.os }}-python${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock', 'pyproject.toml') }}
        restore-keys: |
          uv-${{ runner.os }}-python${{ env.PYTHON_VERSION }}-
          uv-${{ runner.os }}-

    - name: Install dependencies
      run: |
        uv sync
        uv pip install -e .

    - name: Run coverage for current branch
      run: |
        uv run pytest tests/ --cov=segnomms --cov-report=xml:coverage-current.xml -q
        CURRENT_COVERAGE=$(uv run coverage report --format=total)
        echo "CURRENT_COVERAGE=${CURRENT_COVERAGE}" >> "${GITHUB_ENV}"

    - name: Run coverage for base branch
      run: |
        # Fetch base branch and checkout
        git fetch origin ${{ github.base_ref }}
        git checkout origin/${{ github.base_ref }}

        # Install dependencies for base branch
        uv sync || echo "Warning: uv sync failed for base branch"
        uv pip install -e . || echo "Warning: package install failed for base branch"

        # Run tests with fallback
        if uv run pytest tests/ --cov=segnomms --cov-report=xml:coverage-base.xml -q; then
          BASE_COVERAGE=$(uv run coverage report --format=total 2>/dev/null || echo "0")
        else
          echo "Warning: Base branch tests failed, using coverage of 0"
          BASE_COVERAGE="0"
        fi
        echo "BASE_COVERAGE=${BASE_COVERAGE}" >> "${GITHUB_ENV}"

    - name: Calculate coverage diff
      run: repo/calculate_coverage_diff.sh

    - name: Comment coverage diff
      uses: actions/github-script@v8
      with:
        script: |
          const diff = process.env.COVERAGE_DIFF;
          const current = process.env.CURRENT_COVERAGE;
          const base = process.env.BASE_COVERAGE;
          const icon = process.env.DIFF_ICON;

          const diffText = diff > 0 ? `+${diff}%` : `${diff}%`;

          const body = `## ${icon} Coverage Comparison

          | | Coverage |
          |---|---|
          | **Current Branch** | ${current}% |
          | **Base Branch** | ${base}% |
          | **Difference** | ${diffText} |

          ${diff < -5 ? 'âš ï¸ **Warning:** Significant coverage decrease detected!' : ''}
          ${diff > 5 ? 'ğŸ‰ **Great!** Coverage improved significantly!' : ''}
          `;

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

  coverage-quality-gate:
    name: Coverage Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [coverage-analysis, coverage-diff]
    if: always()

    steps:
    - uses: actions/checkout@v6

    - name: Check coverage requirements
      run: |
        echo "ğŸ” Coverage Quality Gate Evaluation"
        echo "=================================="

        # Check if coverage analysis job succeeded
        if [[ "${{ needs.coverage-analysis.result }}" != "success" ]]; then
          echo "âŒ Coverage analysis failed"
          exit 1
        fi

        # For PR: check if coverage diff job succeeded (if it ran)
        if [[ "${{ github.event_name }}" == "pull_request" ]] && [[ "${{ needs.coverage-diff.result }}" == "failure" ]]; then
          echo "âŒ Coverage diff analysis failed"
          exit 1
        fi

        echo "âœ… All coverage checks passed"
        echo ""
        echo "ğŸ“Š Coverage Quality Summary:"
        echo "  - Coverage analysis: ${{ needs.coverage-analysis.result }}"
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "  - Coverage diff: ${{ needs.coverage-diff.result }}"
        fi
        echo ""
        echo "ğŸ‰ Coverage quality gate passed!"
